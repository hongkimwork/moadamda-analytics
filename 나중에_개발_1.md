# 주문 중심 고객 여정 분석 - 추가 개발 계획

> 작성일: 2025-10-20  
> 상태: 보류 (대표님 요청 - DB 테이블 뷰어 우선 처리)  
> 재개 예정: 테이블 뷰어 완료 후

---

## ✅ 현재까지 완료된 기능 (Step 1-4)

### **Step 1: IP 추적 인프라**
- ✅ PostgreSQL 테이블에 `ip_address`, `last_ip` 컬럼 추가
- ✅ 백엔드에서 클라이언트 IP 추출 (`x-forwarded-for`, `x-real-ip` 지원)
- ✅ `visitors`, `sessions` 테이블에 IP 저장

**파일**:
- `backend/migrations/add_ip_tracking.sql`
- `backend/src/routes/track.js`

---

### **Step 2: 주문 목록 API**
- ✅ 날짜별/디바이스별 필터링
- ✅ 페이지네이션 (기본 20건/페이지)
- ✅ IP, UTM, 디바이스 정보 포함
- ✅ `GET /api/stats/orders` 엔드포인트

**파일**:
- `backend/src/routes/stats.js`

---

### **Step 3: 고객 여정 분석 API**
- ✅ 주문 상세 정보 조회
- ✅ 페이지 이동 경로 (세션 내 모든 페이지뷰)
- ✅ 동일 쿠키 UTM 히스토리 (광고 접촉 이력)
- ✅ 동일 IP 과거 방문 기록
- ✅ 과거 구매 이력 (동일 고객)
- ✅ `GET /api/stats/order-detail/:orderId` 엔드포인트

**파일**:
- `backend/src/routes/stats.js`

---

### **Step 4: 프론트엔드 대시보드**
- ✅ 주문 목록 테이블 (날짜/디바이스 필터)
- ✅ 고객 여정 분석 페이지
  - 주문 정보 (IP, 디바이스, UTM 등)
  - 페이지 이동 경로 타임라인 (왼쪽 정렬)
  - 동일 쿠키 유입 기록
  - 동일 IP 과거 방문 기록
  - 과거 구매 이력
- ✅ React Router 기반 네비게이션
- ✅ Ant Design UI 컴포넌트

**파일**:
- `frontend/src/App.jsx` (현재 → `pages/OrderAnalysis.jsx`로 이동 예정)
- `frontend/src/main.jsx`

---

## 🚀 향후 개발 예정 기능 (재개 시 진행)

### **Step 6: 페이지별 체류 시간 분석** ⭐ **우선순위 1**

**목표**: 각 페이지에서 사용자가 얼마나 머물렀는지 계산하여 관심도 파악

**구현 내용**:
1. **백엔드 로직**:
   - 페이지뷰 간 시간 차이 계산
   - SQL: `LEAD()` 윈도우 함수로 다음 페이지뷰 시간 가져오기
   - 마지막 페이지는 구매 시간 또는 세션 종료 시간 사용

2. **프론트엔드 표시**:
   - 타임라인에 체류 시간 추가
   - 예: `📄 상품 상세 페이지 (2분 30초 체류) 🔥`
   - 1분 이상 체류 → 🔥 아이콘 강조
   - 10초 미만 → ⚡ 빠른 이동 표시

3. **통계 정보**:
   - 총 체류 시간: `12분 30초`
   - 평균 페이지 체류: `42초`
   - 가장 오래 본 페이지: `주문서 작성 (3분 10초)`

**파일 수정**:
- `backend/src/routes/stats.js` (페이지 경로 API 수정)
- `frontend/src/pages/OrderAnalysis.jsx` (타임라인 표시 개선)

**예시 SQL**:
```sql
SELECT 
  page_url,
  timestamp,
  LEAD(timestamp) OVER (ORDER BY timestamp) - timestamp AS duration_seconds
FROM pageviews
WHERE session_id = ?
ORDER BY timestamp;
```

---

### **Step 7: 페이지 경로 한글 표시 (옵션 B)** ⭐ **우선순위 2**

**목표**: URL을 읽기 쉬운 한글 이름으로 변환하여 가독성 향상

**URL → 한글 매핑 테이블**:
| URL 패턴 | 한글 이름 | 아이콘 |
|----------|-----------|--------|
| `/` | 메인 페이지 | 🏠 |
| `/surl/P/146` | 모로실 다이어트&혈당 관리 | 📦 |
| `/surl/p/129` | 건강을 모아담다 | 📦 |
| `/category/건강/31/` | 건강 카테고리 | 🗂️ |
| `/product/list.html` | 전체 상품 목록 | 📋 |
| `/order/basket.html` | 장바구니 | 🛒 |
| `/order/orderform.html` | 주문서 작성 | 📝 |
| `/member/login.html` | 로그인 | 🔐 |
| `/protected/loginSns.html` | SNS 로그인 | 🔐 |
| `/coupon/coupon_select.html` | 쿠폰 선택 | 🎟️ |
| `/order/order_result.html` | 주문 완료 | ✅ |

**구현 내용**:
1. **URL 매칭 함수**:
   ```javascript
   function urlToKorean(url) {
     const patterns = [
       { regex: /^https?:\/\/[^\/]+\/$/, name: '메인 페이지', icon: '🏠' },
       { regex: /\/surl\/P\/146/, name: '모로실 상품 페이지', icon: '📦' },
       // ... 나머지 패턴
     ];
     
     for (const { regex, name, icon } of patterns) {
       if (regex.test(url)) return { name, icon, url };
     }
     return { name: url, icon: '📄', url }; // 기본값
   }
   ```

2. **UI 개선**:
   - 토글 버튼 추가: `[원본 URL] / [한글 이름]`
   - 한글 이름 표시 시 호버하면 툴팁으로 원본 URL 표시
   - 로컬스토리지에 사용자 선택 저장

3. **타임라인 표시 예시**:
   ```
   Before:
   📄 1단계 13:54:58
   https://moadamda.com/surl/P/146?utm_source=meta&utm_medium=...
   
   After:
   📦 모로실 상품 페이지 13:54:58 (2분 30초)
   [원본 URL 보기 ▼]
   ```

**파일 수정**:
- `frontend/src/utils/urlToKorean.js` (신규)
- `frontend/src/pages/OrderAnalysis.jsx`

---

### **Step 8-2: 페이지 이동 플로우차트** ✨ **우선순위 3**

**목표**: 타임라인 외에 시각적 플로우차트 추가하여 고객 여정을 한눈에 파악

**구현 방식**:
- 라이브러리: React Flow 또는 Mermaid
- 노드: 각 페이지
- 엣지: 페이지 간 이동 (화살표)
- 노드 크기: 체류 시간에 비례
- 색상: 페이지 타입별 (상품/장바구니/결제/완료)

**예시 플로우**:
```
[광고 진입] → [메인] → [상품 상세] → [장바구니] 
                       ↓ 2분 30초       ↓ 45초
                       
                    → [로그인] → [주문서] → [결제 완료]
                                 ↓ 3분 10초    ✅
```

**파일**:
- `frontend/package.json` (react-flow-renderer 추가)
- `frontend/src/components/CustomerJourneyFlow.jsx` (신규)
- `frontend/src/pages/OrderAnalysis.jsx`

---

### **Step 8-3: 엑셀 내보내기** ✨ **우선순위 4**

**목표**: 주문 데이터와 고객 여정을 Excel/CSV로 내보내기

**구현 내용**:
1. **주문 목록 엑셀 내보내기**:
   - 현재 필터링된 주문 전체
   - 컬럼: 주문번호, 시간, 금액, 상품명, IP, UTM 정보 등
   - 파일명: `주문목록_2025-10-13_2025-10-20.xlsx`

2. **고객 여정 PDF 리포트**:
   - 특정 주문의 상세 분석 리포트
   - 포함 내용: 주문 정보, 페이지 경로, UTM 히스토리, 통계
   - 파일명: `고객여정_20251020-0000127.pdf`

**라이브러리**:
- `xlsx` (엑셀)
- `jspdf` + `html2canvas` (PDF)

**파일**:
- `frontend/src/utils/exportToExcel.js` (신규)
- `frontend/src/utils/exportToPDF.js` (신규)
- `frontend/src/pages/OrderAnalysis.jsx`

---

### **Step 8-4: 실시간 알림** ✨ **우선순위 5**

**목표**: 새 주문 발생 시 대시보드에 실시간 알림 표시

**구현 방식** (3가지 옵션):

**Option A: 폴링 (가장 단순)**
```javascript
// 30초마다 새 주문 확인
useEffect(() => {
  const interval = setInterval(async () => {
    const latest = await fetch('/api/stats/orders?limit=1');
    if (latest.order_id !== lastOrderId) {
      showNotification('새 주문 발생!');
    }
  }, 30000);
}, []);
```

**Option B: Server-Sent Events (SSE)**
```javascript
// 백엔드에서 새 주문 발생 시 이벤트 전송
const eventSource = new EventSource('/api/events/orders');
eventSource.onmessage = (event) => {
  const order = JSON.parse(event.data);
  showNotification(`새 주문: ${order.order_id}`);
};
```

**Option C: WebSocket**
```javascript
// 양방향 실시간 통신
const ws = new WebSocket('wss://...');
ws.onmessage = (event) => {
  const order = JSON.parse(event.data);
  showNotification(`새 주문: ${order.order_id}`);
};
```

**추천**: Option A (폴링) - 구현이 가장 단순하고 서버 부하 낮음

**UI**:
- 우측 상단에 `🔔 새 주문 1건` 알림 배지
- 클릭 시 해당 주문 상세 페이지로 이동
- 알림음 재생 (선택적)

**파일**:
- `backend/src/routes/events.js` (신규 - SSE 사용 시)
- `frontend/src/hooks/useOrderNotification.js` (신규)
- `frontend/src/App.jsx`

---

### **Step 8-5: 비교 분석 (마케팅 가치 ★★★★★)** ✨ **우선순위 6**

**목표**: 구매 고객 vs 미구매 방문자 비교 분석하여 전환율 개선 인사이트 제공

**마케터 활용 가치**:
- ⭐⭐⭐⭐⭐ **매우 높음!**
- 어떤 광고가 실제 구매로 이어지는지 명확히 파악
- 비구매 고객이 어디서 이탈하는지 확인
- A/B 테스트 결과 비교
- 마케팅 예산 최적화

**분석 항목**:

1. **기본 통계 비교**:
   | 지표 | 구매 고객 | 미구매 방문자 |
   |------|-----------|---------------|
   | 평균 체류 시간 | 8분 30초 | 2분 15초 |
   | 평균 페이지뷰 | 12.5 페이지 | 4.3 페이지 |
   | 장바구니 도달률 | 87% | 23% |
   | 로그인률 | 95% | 8% |

2. **UTM 캠페인별 전환율**:
   | 캠페인 | 방문자 수 | 구매 건수 | 전환율 |
   |--------|-----------|-----------|--------|
   | meta/asc | 1,245 | 67 | 5.4% |
   | naver/pc_main | 3,421 | 89 | 2.6% |
   | direct | 5,678 | 234 | 4.1% |

3. **페이지별 이탈률**:
   ```
   [진입] 100% → [상품] 78% → [장바구니] 45% → [로그인] 42%
                              ↓ 33% 이탈           ↓ 3% 이탈
                           → [주문서] 38% → [완료] 35%
                                           ↓ 3% 이탈
   ```
   → **장바구니에서 이탈이 가장 많음 (33%)** → 개선 필요!

4. **디바이스별 전환율**:
   - 💻 PC: 4.8%
   - 📱 Mobile: 3.2%
   → **PC가 모바일보다 1.5배 높음**

5. **시간대별 전환율**:
   - 오전 (09:00-12:00): 3.1%
   - 점심 (12:00-14:00): 5.2%
   - 오후 (14:00-18:00): 4.6%
   - 저녁 (18:00-22:00): 6.8% ⭐ **최고**

**UI 구성**:
```
┌─────────────────────────────────────────┐
│  📊 전환율 분석                           │
├─────────────────────────────────────────┤
│  기간: [2025-10-01] ~ [2025-10-20]      │
│                                         │
│  📈 기본 통계 비교                        │
│  [구매 고객] vs [미구매 방문자]           │
│                                         │
│  📊 UTM 캠페인별 전환율 (상위 10개)       │
│  [막대 그래프]                            │
│                                         │
│  🚪 페이지별 이탈 분석                    │
│  [Sankey 다이어그램]                     │
│                                         │
│  💡 개선 제안                             │
│  • 장바구니 이탈률 높음 → 할인 쿠폰 제공  │
│  • 저녁 시간대 광고 집중 투자 권장        │
└─────────────────────────────────────────┘
```

**파일**:
- `backend/src/routes/analytics.js` (신규)
- `frontend/src/pages/ConversionAnalysis.jsx` (신규)
- `frontend/src/components/ConversionChart.jsx` (신규)

---

## 📊 개발 우선순위 (재개 시)

1. **Step 6: 체류 시간 분석** - 핵심 인사이트 제공
2. **Step 7: 한글 페이지 이름** - UX 개선, 빠른 개발
3. **Step 8-5: 비교 분석** - 마케팅 가치 매우 높음
4. **Step 8-2: 플로우차트** - 시각화 개선
5. **Step 8-3: 엑셀 내보내기** - 리포트 기능
6. **Step 8-4: 실시간 알림** - 편의성 개선

---

## 🔄 재개 조건

- ✅ 대표님 요청 기능 (DB 테이블 뷰어) 완료
- ✅ 대표님 승인 및 피드백 반영
- ✅ 테이블 뷰어 안정화 확인

**재개 시**: 이 문서의 Step 6부터 순차적으로 진행

---

## 📝 메모

- **데이터 정합성 이슈**: Slack 알림과 대시보드 데이터 불일치는 정상 (새 시스템은 반영 시점부터 동작)
- **테이블 뷰어 완료 후**: 주문 분석 대시보드와 통합하여 하나의 통합 대시보드 제공
- **사이드바 구조**: 상단(주문 분석) + 하단(데이터 테이블) 메뉴 구성

---

*작성자: AI Assistant*  
*마지막 업데이트: 2025-10-20*

